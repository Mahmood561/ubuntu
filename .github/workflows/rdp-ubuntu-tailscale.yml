name: Ubuntu RDP (GNOME Optimized)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Prepare apt (speed)
        run: |
          sudo rm -rf /var/lib/apt/lists/*
          echo 'Acquire::Retries "5";' | sudo tee /etc/apt/apt.conf.d/80-retries
          echo 'Acquire::http::Timeout "30";' | sudo tee /etc/apt/apt.conf.d/80-timeout

      - name: Install minimal GNOME + XRDP
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            gnome-session gnome-shell gnome-terminal nautilus \
            xrdp xorgxrdp \
            gdm3 xwayland dbus-x11

      - name: Configure session
        run: |
          echo "gnome-session" > ~/.xsession
          sudo sed -i 's/^exec .*$/exec gnome-session/' /etc/xrdp/startwm.sh

      - name: Create RDP user
        run: |
          PASS=$(openssl rand -base64 12)
          sudo useradd -m -s /bin/bash rdp
          echo "rdp:$PASS" | sudo chpasswd
          sudo usermod -aG sudo rdp
          echo "RDP_PASS=$PASS" >> $GITHUB_ENV

      - name: Start XRDP
        run: |
          sudo systemctl restart xrdp
          sudo systemctl restart xrdp-sesman
          sleep 3
          ss -tlnp | grep 3389 || exit 1

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect to Tailscale
        run: |
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="gh-gnome-${{ github.run_id }}"
          for i in {1..12}; do TSIP=$(tailscale ip -4); [ -n "$TSIP" ] && break; sleep 5; done
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV

      - name: Show access info
        run: |
          echo "Address: $TAILSCALE_IP"
          echo "Username: rdp"
          echo "Password: $RDP_PASS"

      - name: Keep alive
        run: |
          while true; do sleep 300; done
